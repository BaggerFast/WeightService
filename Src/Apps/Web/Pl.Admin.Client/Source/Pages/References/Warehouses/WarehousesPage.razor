@using Pl.Admin.Client.Source.Features
@using Pl.Admin.Client.Source.Shared.Api.Web.Endpoints
@using Pl.Admin.Client.Source.Shared.Constants
@using Pl.Admin.Client.Source.Shared.Services.Stores
@using Pl.Admin.Models
@using Pl.Admin.Models.Features.References.Warehouses.Queries

@attribute [Route(Urls.Warehouses)]
@attribute [Authorize(Policy = PolicyEnum.SeniorSupport)]
@rendermode InteractiveServer

<PageTitle>Admin - @Localizer["SectionWarehouses"]</PageTitle>

<UserProductionSiteErrorSuspense>
  <UseEndpoint
    Endpoint="@ReferencesEndpoints.WarehousesEndpoint"
    Arg="@ProductionSiteState.Value.ProductionSite.Id"
    Options="@(PageHelper.DefaultEndpointOptions)"
    Context="warehousesQuery"
  >
    <DataGridHeader>
      <DataGridLabelWithCounter Label="@Localizer["SectionWarehouses"]" ItemsCount="@warehousesQuery.Data?.Length" IsLoading="warehousesQuery.IsLoading"/>
      <DataGridActionReload OnClick="@warehousesQuery.RefetchAsync" IsLoading="warehousesQuery.IsFetching" />
      <AuthorizeView Policy="@PolicyEnum.Admin">
        <DataGridActionCreate OnClick="@OpenCreateDialog" />
      </AuthorizeView>
    </DataGridHeader>

    <DataGridContainer
      TItem="WarehouseDto"
      Items="@(warehousesQuery.HasData ? warehousesQuery.Data : [])"
      OnItemSelect="@(item => OpenUpdateDialog(item))"
    >
      <ColumnsContent>
        <DataGridColumn
          Caption="@WsDataLocalizer["ColName"]"
          Field="@nameof(WarehouseDto.Name)"
          Width="30%"
        />
      </ColumnsContent>
      <ContextMenuContent>
        <DataGridActionUpdateItem TItem="WarehouseDto" Action="@OpenUpdateDialog" />
        <AuthorizeView Policy="@PolicyEnum.Admin" Context="authContext">
          <DataGridActionDeleteItem TItem="WarehouseDto" Action="@DeleteItem" />
        </AuthorizeView>
      </ContextMenuContent>
    </DataGridContainer>
  </UseEndpoint>
</UserProductionSiteErrorSuspense>

@code {
  #region Inject

  [Inject] private IStringLocalizer<ApplicationResources> Localizer { get; set; } = default!;
  [Inject] private IStringLocalizer<WsDataResources> WsDataLocalizer { get; set; } = default!;
  [Inject] private ReferencesEndpoints ReferencesEndpoints { get; set; } = default!;
  [Inject] private PageHelper PageHelper { get; set; } = default!;
  [Inject] private IDialogService DialogService { get; set; } = default!;
  [Inject] private IState<ProductionSiteState> ProductionSiteState { get; set; } = default!;
  [Inject] private IWebApi WebApi { get; set; } = default!;

  #endregion

  private Task OpenCreateDialog() =>
    DialogService.ShowDialogAsync<WarehousesCreateDialog>(PageHelper.DialogParameters);

  private Task OpenUpdateDialog(WarehouseDto item) =>
    DialogService.ShowDialogAsync<WarehousesUpdateDialog>(item, PageHelper.DialogParameters);

  private async Task DeleteItem(WarehouseDto item)
  {
    await WebApi.DeleteWarehouse(item.Id);
    ReferencesEndpoints.DeleteWarehouse(item.ProductionSite.Id, item.Id);
  }
}
